name: E2E Tests (Manual)

on:
  workflow_dispatch:
    inputs:
      test_bucket:
        description: 'GCS test bucket name'
        required: true
        type: string

env:
  VCPKG_BINARY_SOURCES: 'clear;x-gha,readwrite'

jobs:
  build-and-test:
    name: Build and Run E2E Tests
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Set up cache for vcpkg
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/vcpkg
            ~/vcpkg
          key: ${{ runner.os }}-vcpkg-${{ hashFiles('**/CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-vcpkg-
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            pkg-config \
            git \
            libfuse3-dev \
            fuse3 \
            libgtest-dev \
            curl \
            zip \
            unzip \
            tar \
            ninja-build \
            python3 \
            python3-pip
      
      - name: Install Python dependencies
        run: |
          pip3 install --upgrade pip
          pip3 install pytest pytest-timeout
      
      - name: Install Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: 'latest'
      
      - name: Setup vcpkg
        run: |
          if [ ! -d "$HOME/vcpkg" ]; then
            git clone https://github.com/microsoft/vcpkg $HOME/vcpkg
            $HOME/vcpkg/bootstrap-vcpkg.sh
          fi
          echo "$HOME/vcpkg" >> $GITHUB_PATH
      
      - name: Export GitHub Actions cache environment variables
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');
      
      - name: Install google-cloud-cpp dependencies
        run: |
          cd $HOME/vcpkg
          export VCPKG_MAX_CONCURRENCY=4
          ./vcpkg install google-cloud-cpp[core,storage]:x64-linux --recurse
        timeout-minutes: 60
      
      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          cmake .. -DCMAKE_TOOLCHAIN_FILE=$HOME/vcpkg/scripts/buildsystems/vcpkg.cmake \
                   -DCMAKE_BUILD_TYPE=Release
      
      - name: Build
        run: |
          cd build
          make -j$(nproc)
      
      - name: Run unit tests
        run: |
          cd build
          ctest --output-on-failure --verbose
        continue-on-error: true
      
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
        continue-on-error: false
      
      - name: Set up test environment
        if: steps.auth.outcome == 'success'
        run: |
          # Load FUSE module
          sudo modprobe fuse || echo "FUSE already loaded or not needed"
          
          # Allow non-root users to use FUSE
          sudo chmod 666 /dev/fuse || echo "Cannot change /dev/fuse permissions"
      
      - name: Run E2E tests
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ steps.auth.outputs.credentials_file_path }}
          TEST_BUCKET: ${{ inputs.test_bucket || secrets.GCS_TEST_BUCKET }}
        run: |
          cd tests/e2e
          
          echo "Running E2E tests against bucket: $TEST_BUCKET"
          
          # Run Python-based E2E tests
          for test_script in test_*.py; do
            if [ -f "$test_script" ]; then
              echo "Running $test_script..."
              python3 "$test_script" "$TEST_BUCKET" || echo "Test $test_script failed"
            fi
          done
          
          # Run shell-based E2E tests
          for test_script in test_*.sh; do
            if [ -f "$test_script" ]; then
              echo "Running $test_script..."
              bash "$test_script" "$TEST_BUCKET" || echo "Test $test_script failed"
            fi
          done
        timeout-minutes: 30
        continue-on-error: true
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gcscfuse-binary
          path: |
            build/gcscfuse
          retention-days: 7
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            build/Testing/
            tests/e2e/*.log
          retention-days: 7
      

      
      - name: Cleanup
        if: always()
        run: |
          # Unmount any lingering mounts
          sudo fusermount -u ~/gcs_test_* 2>/dev/null || true
          sudo umount ~/gcs_test_* 2>/dev/null || true
